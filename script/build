#!/usr/bin/env bash

set -efuxo pipefail

ldc2Flags=(
    -O3       # Optimize code.
    -dip1000  # Escape analysis.
)

sphinxBuildFlags=(
    -a            # Disable cache (it's broken).
    -W            # Warnings as errors.
    --keep-going  # Do not stop at first warning.
)

mkdir --parents build

{
    echo "// @generated by $0."
    echo 'module snowflake.config;'
    # Environment variables set by Nix shell.
    echo "enum ENV_PATH = \`$SNOWFLAKE_ENV_PATH\`;"
    echo "enum SH_PATH = \`$SNOWFLAKE_SH_PATH\`;"
} > build/config.d

find source -name '*.d' -type f -print0 | \
    xargs -0 ldc2 -of=build/snowflake "${ldc2Flags[@]}" build/config.d

sphinx-build "${sphinxBuildFlags[@]}" manual build/manual
