#!/usr/bin/env bash

set -efuxo pipefail

# TODO: Parse command line arguments.
release=0

mkdir --parents build

################################################################################
# Generate static configuration

{
    echo "// @generated by $0."
    echo 'module snowflake.config;'
    # Environment variables set by Nix shell.
    echo "enum ENV_PATH = \`$SNOWFLAKE_ENV_PATH\`;"
    echo "enum SH_PATH = \`$SNOWFLAKE_SH_PATH\`;"
} > build/config.d

################################################################################
# Build software

ldc2Flags=(
    -dip1000    # Escape analysis.
    -L-lblake3  # Link with libblake3.
)

if (( $release )); then
    ldc2Flags+=(
        -O3  # Optimize code.
    )
fi

find source -name '*.d' -type f -print0 | \
    xargs -0 ldc2 -of=build/snowflake "${ldc2Flags[@]}" build/config.d

find source -name '*.d' -type f -print0 | \
    xargs -0 ldc2 -of=build/unittest "${ldc2Flags[@]}" -unittest build/config.d

################################################################################
# Run unit tests

build/unittest

################################################################################
# Build manual

sphinxBuildFlags=(
    -a            # Disable cache (it's broken).
    -W            # Warnings as errors.
    --keep-going  # Do not stop at first warning.
)

sphinx-build "${sphinxBuildFlags[@]}" manual build/manual
